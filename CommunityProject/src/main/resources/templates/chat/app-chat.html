<!DOCTYPE html>
<html lang="ko" dir="ltr" data-bs-theme="light" data-color-theme="Blue_Theme" data-layout="horizontal" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" >

<head>
  <!-- Required meta tags -->
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Dima Community Chat</title>

 <!-- Favicon icon-->
  <link rel="shortcut icon" th:href="@{/images/logos/favicon.png}">

  <!-- Core Css -->
  <link rel="stylesheet" th:href="@{/css/styles.css}">

  <!-- External Libraries -->
    <script th:src="@{/libs/jquery-3.7.1.min.js}"></script>
	<script th:src="@{/libs/sockjs.min.js}"></script>
	<script th:src="@{/libs/stomp.min.js}"></script>
	<script th:src="@{/libs/axios.min.js}"></script>
</head>

<body class="link-sidebar" >
  <!-- Preloader -->
  <div class="preloader">
    <img src="/images/logos/favicon.png" alt="loader" class="lds-ripple img-fluid" />
  </div>
  <div id="main-wrapper">
    <!-- Sidebar Start -->
    <aside class="left-sidebar with-vertical">
      <div><!-- ---------------------------------- -->
        <!-- Start Vertical Layout Sidebar -->
        <!-- ---------------------------------- -->
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="../index.html" class="text-nowrap logo-img">
            <img th:src="@{/images/logos/dark-logo.svg}" class="dark-logo" alt="Logo-Dark" />
            <img th:src="@{/images/logos/light-logo.svg}" class="light-logo" alt="Logo-light" />
          </a>
          <a href="javascript:void(0)" class="sidebartoggler ms-auto text-decoration-none fs-5 d-block d-xl-none">
            <i class="ti ti-x"></i>
          </a>
        </div>


        <nav class="sidebar-nav scroll-sidebar" data-simplebar>
          <ul id="sidebarnav">
            <!-- ---------------------------------- -->
            <!-- Home -->
            <!-- ---------------------------------- -->
            <li class="nav-small-cap">
              <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
              <span class="hide-menu">Home</span>
            </li>
            <!-- ---------------------------------- -->
            <!-- Dashboard -->
            <!-- ---------------------------------- -->
            <li class="sidebar-item">
              <a class="sidebar-link" href="" id="get-url" aria-expanded="false">
                <span>
                  <i class="ti ti-aperture"></i>
                </span>
                <span class="hide-menu">Modern</span>
              </a>
            </li>
            
          </ul>
        </nav>

        <div class="fixed-profile p-3 mx-4 mb-2 bg-secondary-subtle rounded mt-3">
          <div class="hstack gap-3">
            <div class="john-img">
              <img id="userProfileImage" class="rounded-circle" width="40" height="40" alt="modernize-img" />
            </div>
            <div class="john-title">
              <h6 class="mb-0 fs-4 fw-semibold" th:text="${currentUserName}">User Name</h6>
              <span class="fs-2" th:text="${currentUserRole}">Designer</span>
            </div>
            <button class="border-0 bg-transparent text-primary ms-auto" tabindex="0" type="button" aria-label="logout" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="logout">
              <i class="ti ti-power fs-6"></i>
            </button>
          </div>
        </div>
      </div>
    </aside>
    <!--  Sidebar End -->

    <div class="page-wrapper">
    <!--  Header Start -->
    <header class="topbar">
        <div class="with-vertical">
            <!-- ---------------------------------- -->
            <!-- Start Vertical Layout Header -->
            <!-- ---------------------------------- -->
            <nav class="navbar navbar-expand-lg p-0">
                <ul class="navbar-nav">
                    <li class="nav-item nav-icon-hover-bg rounded-circle ms-n2">
                        <a class="nav-link sidebartoggler" id="headerCollapse" href="javascript:void(0)">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="nav-item nav-icon-hover-bg rounded-circle d-none d-lg-flex">
                        <a class="nav-link" href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#exampleModal">
                            <i class="ti ti-search"></i>
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav quick-links d-none d-lg-flex align-items-center">
                    <li class="nav-item nav-icon-hover-bg rounded w-auto dropdown d-none d-lg-block mx-0">
                        <a class="nav-link" href="javascript:void(0)">Apps</a>
                    </li>
                    <li class="nav-item dropdown-hover d-none d-lg-block">
                        <a class="nav-link" href="">Chat</a>
                    </li>
                </ul>

                <div class="d-block d-lg-none py-4">
                    <a href="../horizontal/index.html" class="text-nowrap logo-img">
                        <img th:src="@{/images/logos/dark-logo.svg}" class="dark-logo" alt="Logo-Dark" />
                    </a>
                </div>
                <a class="navbar-toggler nav-icon-hover-bg rounded-circle p-0 mx-0 border-0" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="ti ti-dots fs-7"></i>
                </a>
                <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                    <div class="d-flex align-items-center justify-content-between">
                        <a href="javascript:void(0)" class="nav-link nav-icon-hover-bg rounded-circle mx-0 ms-n1 d-flex d-lg-none align-items-center justify-content-center" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobilenavbar" aria-controls="offcanvasWithBothOptions">
                            <i class="ti ti-align-justified fs-7"></i>
                        </a>
                        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-center">
                            <!-- ------------------------------- -->
                            <!-- start notification Dropdown -->
                            <!-- ------------------------------- -->
                            <li class="nav-item nav-icon-hover-bg rounded-circle dropdown">
                                <a class="nav-link position-relative" href="javascript:void(0)" id="drop2" aria-expanded="false">
                                    <i class="ti ti-bell-ringing"></i>
                                    <div class="notification bg-primary rounded-circle"></div>
                                </a>
                            </li>
                            <!-- ------------------------------- -->
                            <!-- end notification Dropdown -->
                            <!-- ------------------------------- -->

                            <!-- ------------------------------- -->
                            <!-- start profile Dropdown -->
                            <!-- ------------------------------- -->
                            <li class="nav-item dropdown">
                                <a class="nav-link pe-0" href="javascript:void(0)" id="drop1" aria-expanded="false">
                                    <div class="d-flex align-items-center">
                                        <div class="user-profile-img">
                                            <img id="userProfileImage" class="rounded-circle" width="35" height="35" alt="modernize-img" />
                                        </div>
                                    </div>
                                </a>
                                <div class="dropdown-menu content-dd dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop1">
                                    <div class="profile-dropdown position-relative" data-simplebar>
                                        <div class="py-3 px-7 pb-0">
                                            <h5 class="mb-0 fs-5 fw-semibold">User Profile</h5>
                                        </div>
                                        <div class="d-flex align-items-center py-9 mx-7 border-bottom">
                                            <img id="userProfileImage" class="rounded-circle" width="80" height="80" alt="modernize-img" />
                                            <div class="ms-3">
                                                <h5 class="mb-1 fs-3">Mathew Anderson</h5>
                                                <span class="mb-1 d-block">Designer</span>
                                                <p class="mb-0 d-flex align-items-center gap-2">
                                                    <i class="ti ti-mail fs-4"></i> info@modernize.com
                                                </p>
                                            </div>
                                        </div>
                                        <div class="message-body">
                                            <a href="../horizontal/page-user-profile.html" class="py-8 px-7 mt-8 d-flex align-items-center">
                                                <span class="d-flex align-items-center justify-content-center text-bg-light rounded-1 p-6">
                                                    <img th:src="@{/images/svgs/icon-account.svg}" alt="modernize-img" width="24" height="24" />
                                                </span>
                                                <div class="w-100 ps-3">
                                                    <h6 class="mb-1 fs-3 fw-semibold lh-base">My Profile</h6>
                                                    <span class="fs-2 d-block text-body-secondary">Account Settings</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <!-- ------------------------------- -->
                            <!-- end profile Dropdown -->
                            <!-- ------------------------------- -->
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    <!--  Header End -->
        
      <div class="body-wrapper">
    <div class="container-fluid">
        <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4">
            <div class="card-body px-4 py-3">
                <div class="row align-items-center">
                    <div class="col-9">
                        <h4 class="fw-semibold mb-8">Chat</h4>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a class="text-muted text-decoration-none" href="../horizontal/index.html">Home</a>
                                </li>
                                <li class="breadcrumb-item" aria-current="page">Chat</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="col-3">
                        <div class="text-center mb-n5">
                            <img th:src="@{/images/breadcrumb/ChatBc.png}" alt="modernize-img" class="img-fluid mb-n4" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card overflow-hidden chat-application">
            <div class="d-flex align-items-center justify-content-between gap-6 m-3 d-lg-none">
                <button class="btn btn-primary d-flex" type="button" data-bs-toggle="offcanvas" data-bs-target="#chat-sidebar" aria-controls="chat-sidebar">
                    <i class="ti ti-menu-2 fs-5"></i>
                </button>
                <form class="position-relative w-100">
                    <input type="text" class="form-control search-chat py-2 ps-5" id="text-srh" placeholder="Search Contact" />
                    <i class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
                </form>
            </div>
            <div class="d-flex">
                <div class="w-30 d-none d-lg-block border-end user-chat-box">
                    <div class="px-4 pt-9 pb-6">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <!-- 로그인한 회원 프로필 -->
                                <div class="position-relative">
                                    <img id="userProfileImage" alt="user1" width="54" height="54" class="rounded-circle" />
                                    <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                                        <span class="visually-hidden">New alerts</span>
                                    </span>
                                </div>
                                <div class="ms-3">
                                    <h6 id="userName" class="fw-semibold mb-2">User Name</h6>
                                    <p id="userRole" class="mb-0 fs-2">User ID</p>
                                </div>
                            </div>
                            <div class="dropdown">
                                <a class="text-dark fs-6 nav-icon-hover" href="javascript:void(0)" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="ti ti-dots-vertical"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <!-- 마이페이지 -->
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2 border-bottom" href="javascript:void(0)">
                                            <span>
                                                <i class="ti ti-settings fs-4"></i>
                                            </span>Setting
                                        </a>
                                    </li>
                                    <!-- 로그아웃 -->
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2" href="javascript:void(0)">
                                            <span>
                                                <i class="ti ti-login fs-4"></i>
                                            </span>Sign Out
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- 대화 상대 선택 및 시작 -->
                        <div class="d-flex align-items-center mb-4">
                            <select class="select2 form-control" id="recipientSelect">
                                <option value="" disabled selected>대화 상대를 선택하세요</option>
                                <option th:each="member : ${members}" th:value="${member.memberId}" th:text="${member.memberName}"></option>
                            </select>
                            <button id="startChat" class="btn btn-primary hstack gap-6 ms-2">
                                <i class="ti ti-circle-plus ms-1 fs-5"></i>
                            </button>
                        </div>
                    </div>

                    <form class="position-relative mb-4">
                        <input type="text" class="form-control search-chat py-2 ps-5" id="text-srh" placeholder="Search Contact" />
                        <i class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
                    </form>

                    <div class="app-chat" id="chatList">
                        <ul class="chat-users mb-0 mh-n100" data-simplebar>
                            <!-- 1 채팅방 -->
                            <li th:each="room : ${chatRooms}" th:data-room-id="${room.id}" th:text="${room.name}">
                                <a href="javascript:void(0)" class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user bg-light-subtle" id="chat_user_1" th:data-user-id="${room.id}">
                                    <div class="d-flex align-items-center">
                                        <span class="position-relative">
                                            <img id="userProfileImage" alt="user1" width="48" height="48" class="rounded-circle" />
                                            <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                                                <span class="visually-hidden">New alerts</span>
                                            </span>
                                        </span>
                                        <div class="ms-3 d-inline-block w-75">
                                            <h6 class="mb-1 fw-semibold chat-title" th:text="${room.name}">
                                                Room Name
                                            </h6>
                                            <span class="fs-3 text-truncate text-body-color d-block">You: Yesterdy was great...</span>
                                        </div>
                                    </div>
                                    <p class="fs-2 mb-0 text-muted">15 mins</p>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="w-70 w-xs-100 chat-container">
                    <div class="chat-box-inner-part h-100">
                        <div class="chat-not-selected h-100 d-none">
                            <div class="d-flex align-items-center justify-content-center h-100 p-5">
                                <div class="text-center">
                                    <span class="text-primary">
                                        <i class="ti ti-message-dots fs-10"></i>
                                    </span>
                                    <h6 class="mt-2">Open chat from the list</h6>
                                </div>
                            </div>
                        </div>

                        <div class="chatting-box d-block">
                            <div class="p-9 border-bottom chat-meta-user d-flex align-items-center justify-content-between">
                                <div class="hstack gap-3 current-chat-user-name">
                                    <div class="position-relative">
                                        <img id="userProfileImage" alt="user1" width="48" height="48" class="rounded-circle" />
                                        <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                                            <span class="visually-hidden">New alerts</span>
                                        </span>
                                    </div>
                                    <div>
                                        <h6 class="mb-1 name fw-semibold"></h6>
                                        <p class="mb-0">Away</p>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex parent-chat-box app-chat-right">
                                <div class="chat-box w-xs-100">
                                    <div class="chat-box-inner p-9" data-simplebar id="messageArea">
                                        <!-- 메시지 영역 -->
                                    </div>
                                    <div class="px-9 py-6 border-top chat-send-message-footer">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center gap-2 w-85">
                                                <a class="position-relative nav-icon-hover z-index-5" href="javascript:void(0)">
                                                    <i class="ti ti-mood-smile text-dark bg-hover-primary fs-7"></i>
                                                </a>
                                                <input type="text" class="form-control message-type-box text-muted border-0 p-0 ms-2" id="messageInput" placeholder="Type a Message" />
                                            </div>
                                            <button id="sendButton" class="btn btn-primary">전송</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="offcanvas offcanvas-start user-chat-box chat-offcanvas" tabindex="-1" id="chat-sidebar" aria-labelledby="offcanvasExampleLabel">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Chats</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="px-4 pt-9 pb-6">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center">
                            <div class="position-relative">
                                <img id="userProfileImage" alt="user1" width="54" height="54" class="rounded-circle" />
                                <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                                    <span class="visually-hidden">New alerts</span>
                                </span>
                            </div>
                            <div class="ms-3">
                                <h6 class="fw-semibold mb-2">Mathew Anderson</h6>
                                <p class="mb-0 fs-2">Designer</p>
                            </div>
                        </div>
                        <div class="dropdown">
                            <a class="text-dark fs-6 nav-icon-hover" href="javascript:void(0)" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="ti ti-dots-vertical"></i>
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2 border-bottom" href="javascript:void(0)">
                                        <span><i class="ti ti-settings fs-4"></i></span>Setting
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2" href="javascript:void(0)">
                                        <span><i class="ti ti-login fs-4"></i></span>Sign Out
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <form class="position-relative mb-4">
                        <input type="text" class="form-control search-chat py-2 ps-5" id="text-srh" placeholder="Search Contact" />
                        <i class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
                    </form>
                </div>
                <div class="app-chat">
                    <ul class="chat-users mh-n100" data-simplebar>
                        <li th:each="room : ${chatRooms}">
                            <a href="javascript:void(0)" class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user bg-light-subtle" id="chat_user_1" th:data-user-id="${room.id}">
                                <div class="d-flex align-items-center">
                                    <span class="position-relative">
                                        <img id="userProfileImage" alt="user1" width="48" height="48" class="rounded-circle" />
                                        <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                                            <span class="visually-hidden">New alerts</span>
                                        </span>
                                    </span>
                                    <div class="ms-3 d-inline-block w-75">
                                        <h6 class="mb-1 fw-semibold chat-title" data-username="James Anderson">
                                            Michell Flintoff
                                        </h6>
                                        <span class="fs-3 text-truncate text-body-color d-block">You: Yesterdy was great...</span>
                                    </div>
                                </div>
                                <p class="fs-2 mb-0 text-muted">15 mins</p>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

<!-- Additional JS Scripts -->

<script>
$(document).ready(function () {
    let stompClient = null;
    let currentChatRoomId = null;
    let currentDate = null;

    // 초기 데이터 로드
    function loadInitialData() {
        $.ajax({
            url: '/api/chat/chatData',
            method: 'GET',
            success: function(response) {
                console.log("Received data:", response);  
                console.log("UserID:", response.currentUserId);
	            console.log("Name:", response.currentUserName);
	            console.log("ID:", response.currentUserIdNum);
                
                $('#userName').text(response.currentUserName);
                $('#userId').text(response.currentUserId);
                $('#userRole').text(response.currentUserRole);
                $('#userIdNum').text(response.currentUserIdNum);

                // 채팅방 목록 로드
                updateChatRooms(response.chatRooms, response.currentUserIdNum);

                // 대화 상대 목록 로드
                updateRecipientSelect(response.members);
            },
            error: function(error) {
                console.error('Error loading initial data:', error);
            }
        });
    }

    // 채팅방 목록 업데이트
    function updateChatRooms(chatRooms) {
        $('#chatList').empty();
        chatRooms.forEach(function(room) {
            const roomHtml = `
                <li>
                    <a href="javascript:void(0)" class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user bg-light-subtle" data-room-id="${room.id}">
                        <div class="d-flex align-items-center">
                            <span class="position-relative">
                                <img src="/images/profiles/user-${room.id}.jpg" alt="${room.name}" width="48" height="48" class="rounded-circle" />
                                <span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-success">
                                    <span class="visually-hidden">New alerts</span>
                                </span>
                            </span>
                            <div class="ms-3 d-inline-block w-75">
                                <h6 class="mb-1 fw-semibold chat-title" data-username="${room.name}">
                                    ${room.name}
                                </h6>
                            </div>
                        </div>
                    </a>
                </li>`;
            $('#chatList').append(roomHtml);
        });
        registerChatRoomClickEvent();
    }

    // 대화 상대 목록 업데이트
    function updateRecipientSelect(members) {
        $('#recipientSelect').empty();
        members.forEach(function(member) {
            $('#recipientSelect').append(`<option value="${member.memberId}">${member.memberName}</option>`);
        });
    }

    // 채팅방 클릭 이벤트 등록
    function registerChatRoomClickEvent() {
        $('.chat-user').off('click').on('click', function () {
            const selectedRoomId = $(this).data('room-id');
            if (selectedRoomId) {
                joinChatRoom(selectedRoomId);
            } else {
                console.error('Invalid room ID:', selectedRoomId);
            }
        });
    }

    // STOMP 연결 및 구독 설정
    function connect() {
        const socket = new SockJS('/stomp/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            const userId = $('#userId').text();

            stompClient.subscribe(`/user/${userId}/queue/newChatRoom`, function (messageOutput) {
                const chatRoom = JSON.parse(messageOutput.body);
                updateChatRooms([chatRoom]);
            });

            if (currentChatRoomId) {
                joinChatRoom(currentChatRoomId);
            }
        });
    }

    $('#startChat').click(function () {
	    const recipientId = $('#recipientSelect').val();  // 선택한 상대방의 ID
	    if (recipientId) {
	        axios.post('/api/chat/start', `recipientId=${encodeURIComponent(recipientId)}`, {
	            headers: {
	                'Content-Type': 'application/x-www-form-urlencoded'
	            }
	        })
	        .then(response => {
	            currentChatRoomId = response.data.id;
	            if (currentChatRoomId) {
	                joinChatRoom(currentChatRoomId);
	                loadInitialData();  // 전체 초기 데이터 로드, 채팅방 목록 갱신 포함

	                // 상대방에게 새로운 채팅방 정보를 알림
	                stompClient.send(`/user/${recipientId}/queue/newChatRoom`, {}, JSON.stringify({ roomId: currentChatRoomId }));
	            } else {
	                console.error('Failed to retrieve chat room ID.');
	            }
	        })
	        .catch(error => {
	            console.error('Error starting chat room:', error);
	        });
	    } else {
	        console.error('Recipient ID is not selected.');
	    }
	});

    // 채팅방 참여 및 메시지 수신 설정
    function joinChatRoom(roomId) {
        if (stompClient && roomId) {
            if (currentChatRoomId) {
                stompClient.unsubscribe(`sub-${currentChatRoomId}`);
            }

            currentChatRoomId = roomId;
            currentDate = null;

            const queue = `/queue/chat.room.${roomId}`;
            stompClient.subscribe(queue, function (messageOutput) {
                const message = JSON.parse(messageOutput.body);
                showMessage(message);
            }, { id: `sub-${roomId}` });

            loadChatMessages(roomId);

            const enterMessage = {
                senderId: $('#userId').text(),
                chatRoomId: roomId,
                content: ''
            };
            stompClient.send(`/app/chat.enter/${roomId}`, {}, JSON.stringify(enterMessage));
        }
    }

    // 메시지 로드
    function loadChatMessages(roomId) {
        axios.get(`/chatRoom/getMessages/${roomId}`)
            .then(response => {
                $('#messageArea').empty();
                response.data.forEach(message => {
                    showMessage(message);
                });
            })
            .catch(error => {
                console.error('Error loading messages:', error);
            });
    }

    // 메시지 표시
    function showMessage(message) {
        const currentUserId = $('#userId').text();
        const messageDate = new Date(message.timestamp);
        const hours = messageDate.getHours().toString().padStart(2, '0');
        const minutes = messageDate.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        const messageHtml = message.senderId === currentUserId ? `
            <div class="hstack gap-3 align-items-start mb-7 justify-content-end">
                <div class="text-end">
                    <div class="p-2 bg-info-subtle text-dark rounded-1 d-inline-block fs-3">
                        ${message.content}
                    </div>
                    <div class="text-muted fs-2">${timeString}</div>
                </div>
            </div>` : `
            <div class="hstack gap-3 align-items-start mb-7 justify-content-start">
                <img id="userProfileImage" alt="${message.senderName}" width="40" height="40" class="rounded-circle" />
                <div>
                    <h6 class="fs-2 text-muted">${message.senderName}</h6>
                    <div class="p-2 text-bg-light rounded-1 d-inline-block text-dark fs-3">
                        ${message.content}
                    </div>
                    <div class="text-muted fs-2">${timeString}</div>
                </div>
            </div>`;
        
        $('#messageArea').append(messageHtml);
    }

    // 메시지 전송
    $('#sendButton').click(function () {
        const content = $('#messageInput').val();
        if (content && stompClient && currentChatRoomId) {
            const message = {
                chatRoomId: currentChatRoomId,
                senderId: $('#userId').text(),
                content: content,
                timestamp: new Date().toISOString()
            };
            stompClient.send(`/app/chat.message/${currentChatRoomId}`, {}, JSON.stringify(message));
            $('#messageInput').val('');
        }
    });

    // 초기 데이터 및 STOMP 연결 설정
    loadInitialData();
    connect();
});
</script>
      
    </div>
  </div>
  <div class="dark-transparent sidebartoggler"></div>
    <script th:src="@{/js/vendor.min.js}"></script>
  <!-- Import Js Files -->
  <script th:src="@{/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/js/theme/app.horizontal.init.js}"></script>
  <script th:src="@{/js/theme/theme.js}"></script>
  <script th:src="@{/js/theme/app.min.js}"></script>
  <script th:src="@{/js/theme/sidebarmenu.js}"></script>

  <!-- solar icons -->
  
  <script th:src="@{/js/apps/chat.js}"></script>
</body>

</html>