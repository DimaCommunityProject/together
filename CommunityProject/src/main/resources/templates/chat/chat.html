<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅</title>
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    <script src="/script/jquery-3.7.1.min.js"></script>
    <script src="/script/sockjs.min.js"></script>
    <script src="/script/stomp.min.js"></script>
    <script src="/script/axios.min.js"></script>
</head>
<body data-current-user-id="[[${currentUserId}]]" data-current-user-name="[[${currentUserName}]]">
    <div id="chatContainer">
        <div id="chatSidebar">
		    <div id="userInfo">
		        <h3 id="userName" th:text="${currentUserName}">User Name</h3>
		        <p id="userId" th:text="${currentUserId}">User ID</p>
		    </div>
		    <!-- 대화 상대 선택 -->
		    <select id="recipientSelect">
		        <option value="" disabled selected>대화 상대를 선택하세요</option>
		        <option th:each="member : ${members}" 
		                th:value="${member.memberId}" 
		                th:text="${member.memberName}"></option>
		    </select>
		    <button id="startChat">채팅하기</button>
		    <div id="chatList">
		        <!-- 채팅방 리스트가 여기에 추가됩니다 -->
		        <div th:each="room : ${chatRooms}" class="chatRoom" th:data-room-id="${room.id}" th:text="${room.name}"></div>
		    </div>
		</div>
        <!-- 채팅 메인 영역 -->
        <div id="chatMain">
            <div id="chatHeader">
                <h3 id="chatUserName"></h3>
                <p id="chatUserStatus">online</p>
            </div>
            <div id="messageArea">
                <!-- 메시지 표시 영역 -->
            </div>
            <div id="sendMessageArea">
                <input type="text" id="messageInput" placeholder="메시지를 입력하세요"/>
                <button id="sendButton">전송</button>
            </div>
        </div>
    </div>
   <script th:inline="javascript">
	    $(document).ready(function () {
	        let stompClient = null;
	        let currentChatRoomId = null;
	
	        function loadInitialData() {
	            $.ajax({
	                url: '/api/chat/chatData',
	                method: 'GET',
	                success: function(response) {
	                    $('#userName').text(response.currentUserName);
	                    $('#userId').text(response.currentUserId);
	
	                    // 채팅방 목록 로드
	                    updateChatRooms(response.chatRooms);
	
	                    // 대화 상대 목록 로드
	                    updateRecipientSelect(response.members);
	                },
	                error: function(error) {
	                    console.error('Error loading initial data:', error);
	                }
	            });
	        }
	
	        function loadChatRooms() {
	            axios.get('/api/chat/getRooms')
	                .then(response => {
	                    const rooms = response.data;
	                    const chatRoomList = document.getElementById('chatList'); // 채팅방 리스트를 표시할 요소
	                    chatRoomList.innerHTML = ''; // 기존 목록을 초기화합니다.

	                    rooms.forEach(room => {
	                        const roomElement = document.createElement('div');
	                        roomElement.classList.add('chatRoom');
	                        roomElement.innerHTML = room.name;
	                        roomElement.setAttribute('data-room-id', room.id);
	                        roomElement.addEventListener('click', function () {
	                            joinChatRoom(room.id);
	                        });
	                        chatRoomList.appendChild(roomElement);
	                    });
	                })
	                .catch(error => {
	                    console.error('Error loading chat rooms:', error);
	                });
	        }
	
	        function updateChatRooms(chatRooms) {
	            $('#chatList').empty();
	            chatRooms.forEach(function(room) {
	                $('#chatList').append(`<div class="chatRoom" data-room-id="${room.id}">${room.name}</div>`);
	            });
	            registerChatRoomClickEvent();
	        }
	
	        function updateRecipientSelect(members) {
	            $('#recipientSelect').empty();
	            members.forEach(function(member) {
	                $('#recipientSelect').append(`<option value="${member.memberId}">${member.memberName}</option>`);
	            });
	        }
	
	        function registerChatRoomClickEvent() {
	            $('.chatRoom').off('click').on('click', function () {
	                currentChatRoomId = $(this).data('room-id');
	                
	                if (currentChatRoomId) {
	                    joinChatRoom(currentChatRoomId);
	                } else {
	                    console.error('Invalid room ID:', currentChatRoomId);
	                }
	            });
	        }
	
	        function connect() {
	            const socket = new SockJS('/stomp/chat');
	            stompClient = Stomp.over(socket);
	            stompClient.connect({}, function (frame) {
	                console.log('Connected: ' + frame);
	                
	             // 첫 채팅방 구독 설정
	                if (currentChatRoomId) {
	                    joinChatRoom(currentChatRoomId);
	                }
	            });
	        }
	
	        function joinChatRoom(roomId) {
	            if (stompClient && roomId) {
	                const queue = `/queue/chat.room.${roomId}`;

	                // 기존 구독 해제
	                if (currentChatRoomId) {
	                    stompClient.unsubscribe(currentChatRoomId);
	                }

	                currentChatRoomId = roomId;  // 구독 전에 현재 채팅방 ID를 설정합니다.

	                // 새로운 큐 구독
	                stompClient.subscribe(queue, function (messageOutput) {
	                    const message = JSON.parse(messageOutput.body);
	                    showMessage(message);
	                });

	                // 기존 메시지 로드
	                axios.get(`/chatRoom/getMessages/${roomId}`)
	                    .then(response => {
	                        $('#messageArea').empty();
	                        response.data.forEach(message => {
	                            showMessage(message);
	                        });
	                    })
	                    .catch(error => {
	                        console.error('Error loading messages:', error);
	                    });
	            } else {
	                console.error('Invalid chat room ID:', roomId);
	            }
	        }
	
	        function showMessage(message) {
	            if (typeof message === 'string') {
	                // 문자열일 경우 그대로 출력
	                $('#messageArea').append(`<div><strong>알 수 없음:</strong> ${message}</div>`);
	                return;
	            }

	            if (!message || typeof message.senderId === 'undefined' || typeof message.content === 'undefined') {
	                console.error('Invalid message format:', message);
	                return;
	            }

	            const messageElement = `<div><strong>${message.senderId}:</strong> ${message.content}</div>`;
	            $('#messageArea').append(messageElement);
	        }
	        
	        $('#sendButton').click(function () {
	            const content = $('#messageInput').val();
	            if (content && stompClient && currentChatRoomId) {
	                const message = {
	                    chatRoomId: currentChatRoomId,
	                    senderId: $('#userId').text(),
	                    content: content,
	                    timestamp: new Date().toISOString()
	                };
	                stompClient.send(`/app/chat.message/${currentChatRoomId}`, {}, JSON.stringify(message));
	                $('#messageInput').val('');
	            }
	        });
	
	        $('#startChat').click(function () {
	            const recipientId = $('#recipientSelect').val();
	            if (recipientId) {
	                axios.post('/api/chat/start', `recipientId=${encodeURIComponent(recipientId)}`, {
	                    headers: {
	                        'Content-Type': 'application/x-www-form-urlencoded'
	                    }
	                })
	                .then(response => {
	                    currentChatRoomId = response.data.id;
	                    if (currentChatRoomId) {
	                        joinChatRoom(currentChatRoomId);
	                        loadChatRooms();
	                    } else {
	                        console.error('Failed to retrieve chat room ID.');
	                    }
	                })
	                .catch(error => {
	                    console.error('Error starting chat room:', error);
	                });
	            } else {
	                console.error('Recipient ID is not selected.');
	            }
	        });
	
	        loadInitialData();
	        connect();
	    });
	</script>
   
</body>
</html>